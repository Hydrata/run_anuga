# v0.1.0 Release Status

## Current State (2026-02-22)

**Linux build: PASSING** — full simulation smoke test works end-to-end
**Windows build: FAILING** — anuga doesn't install on Windows CI

## What's Been Done

### Completed
1. GDAL removal merged to `main` on both `anuga_core` and `run_anuga`
2. anuga_core CI fixed (added pytest, --no-build-isolation, all undeclared deps)
3. run_anuga lint fixed (9 ruff errors in run_utils.py)
4. Docker test scripts updated (`@remove-gdal` → `@main`)
5. CLI now accepts `scenario.json` path directly (not just directory) via `resolve_package_dir()` in cli.py
6. Example renamed: `examples/australian_floodplain/` → `examples/small_test/`
7. PyInstaller spec converted from `--onedir` (exe + `_internal/`) to `--onefile` (single exe)
8. Added importlib-based fallback for anuga collection when `collect_all()` fails on Windows
9. Added runtime hook (`pyinstaller_hooks/rthook_projdata.py`) for PROJ_DATA/GDAL_DATA
10. Fixed rasterio data bundling (newer rasterio has `proj_data`/`gdal_data` dirs, not functions)
11. Release workflow has full simulation smoke tests on both platforms (validate → info → run → verify outputs)
12. Examples shipped alongside exe in release zip/tarball (not embedded in exe)
13. All references to `australian_floodplain` updated across README, docker scripts, release workflow

### v0.1.0 Tag
Tag exists on remote pointing to commit `83bc0ed`. Release workflow run `22276470913` failed (Windows).

## The Windows Problem

### Root Cause: anuga won't install on Windows CI

The `pip install "anuga @ git+https://github.com/Hydrata/anuga_core.git@main"` step **silently fails** on Windows. anuga uses meson-python as its build system, which requires:
- A C compiler (gfortran for Fortran extensions)
- `build-essential` equivalent on Windows

The Windows CI runner doesn't have these. The `pip install` line runs but anuga never appears in the installed packages. Then `import anuga` fails at both the debug step and runtime.

### Evidence
- Debug step output: `ModuleNotFoundError: No module named 'anuga'`
- The pip install step doesn't show anuga being built/installed at all in the logs
- On Linux, `apt-get install build-essential gfortran libopenmpi-dev` provides the compilers

### Previous Red Herring
Earlier we thought the problem was PyInstaller's `collect_all('anuga')` failing on Windows ("not a package" warning). That IS a real issue too, but it's secondary — anuga isn't even installed in the first place.

## What Needs to Happen Next

### Option A: Install build tools on Windows CI
Add MSVC/gfortran to the Windows runner before pip installing anuga:
```yaml
- name: Install build tools
  run: |
    choco install mingw -y    # provides gfortran
    # OR use MSVC that comes with windows-latest
```
Then anuga's meson-python build might work. But meson-python + Fortran on Windows is notoriously flaky.

### Option B: Pre-build anuga wheel for Windows
Build a Windows wheel for anuga separately (maybe in anuga_core's own CI) and host it. Then `pip install` from the wheel — no compilation needed on the run_anuga CI.

### Option C: Ship anuga as source-only on Windows
Since anuga's C/Fortran extensions are performance optimizations, check if anuga can run in pure-Python mode on Windows. If so, install with `--no-build-isolation` or similar flags that skip extension compilation.

### After anuga installs, the PyInstaller issue remains
The `collect_all('anuga')` → "not a package" warning on Windows is a separate issue. The importlib fallback in `run_anuga.spec` should handle it, but hasn't been tested yet since anuga never installs.

## Files Modified (from initial state)

| File | Change |
|------|--------|
| `.github/workflows/release.yml` | Single exe, smoke tests, renamed example |
| `README.md` | `australian_floodplain` → `small_test`, scenario.json paths |
| `examples/small_test/` | Renamed from `australian_floodplain`, updated scenario.json name |
| `run_anuga.spec` | Onefile mode, importlib fallback for anuga, removed examples from bundle |
| `run_anuga/cli.py` | Added `resolve_package_dir()` — accepts scenario.json or directory |
| `run_anuga/run_utils.py` | 9 ruff lint fixes |
| `pyinstaller_hooks/rthook_projdata.py` | Runtime hook for PROJ_DATA/GDAL_DATA |
| `test-docker/phase1.sh` | Renamed example paths |
| `test-docker/phase2.sh` | Renamed example paths, `@remove-gdal` → `@main` |
| `test-docker/phase3.sh` | Renamed example paths, `@remove-gdal` → `@main` |

## Key Architecture Decisions

- **Single-file exe** (`--onefile`) instead of directory bundle — simpler distribution
- **Examples shipped outside exe** — in the release zip/tarball alongside the exe
- **importlib fallback** in spec — when `collect_all('anuga')` fails (Windows), manually walk the anuga install dir
- **Runtime hook** for PROJ — prefers rasterio's PROJ data over pyproj's (version mismatch otherwise)
