# v0.1.0 Release Status

## Current State (2026-02-22)

**Linux build: PASSING** — full simulation smoke test works end-to-end
**Windows build: PENDING** — pre-built wheel approach implemented, needs first test run

## What's Been Done

### Completed
1. GDAL removal merged to `main` on both `anuga_core` and `run_anuga`
2. anuga_core CI fixed (added pytest, --no-build-isolation, all undeclared deps)
3. run_anuga lint fixed (9 ruff errors in run_utils.py)
4. Docker test scripts updated (`@remove-gdal` → `@main`)
5. CLI now accepts `scenario.json` path directly (not just directory) via `resolve_package_dir()` in cli.py
6. Example renamed: `examples/australian_floodplain/` → `examples/small_test/`
7. PyInstaller spec converted from `--onedir` (exe + `_internal/`) to `--onefile` (single exe)
8. Added importlib-based fallback for anuga collection when `collect_all()` fails on Windows
9. Added runtime hook (`pyinstaller_hooks/rthook_projdata.py`) for PROJ_DATA/GDAL_DATA
10. Fixed rasterio data bundling (newer rasterio has `proj_data`/`gdal_data` dirs, not functions)
11. Release workflow has full simulation smoke tests on both platforms (validate → info → run → verify outputs)
12. Examples shipped alongside exe in release zip/tarball (not embedded in exe)
13. All references to `australian_floodplain` updated across README, docker scripts, release workflow

### v0.1.0 Tag
Tag exists on remote pointing to commit `83bc0ed`. Release workflow run `22276470913` failed (Windows).

## The Windows Problem

### Root Cause: anuga won't install on Windows CI

The `pip install "anuga @ git+https://github.com/Hydrata/anuga_core.git@main"` step **silently fails** on Windows. anuga uses meson-python as its build system, which requires:
- A C compiler (gfortran for Fortran extensions)
- `build-essential` equivalent on Windows

The Windows CI runner doesn't have these. The `pip install` line runs but anuga never appears in the installed packages. Then `import anuga` fails at both the debug step and runtime.

### Evidence
- Debug step output: `ModuleNotFoundError: No module named 'anuga'`
- The pip install step doesn't show anuga being built/installed at all in the logs
- On Linux, `apt-get install build-essential gfortran libopenmpi-dev` provides the compilers

### Previous Red Herring
Earlier we thought the problem was PyInstaller's `collect_all('anuga')` failing on Windows ("not a package" warning). That IS a real issue too, but it's secondary — anuga isn't even installed in the first place.

## Solution: Pre-built Wheels (Option B — Implemented)

We chose **Option B: Pre-build anuga wheels** and implemented it as follows:

### New workflow: `anuga_core/.github/workflows/build-wheels.yml`
- Builds Linux + Windows wheels for Python 3.12
- Uses conda + `gcc_win-64`/`gxx_win-64` on Windows (same toolchain as anuga_core's existing PyPI workflow)
- Uses `repairwheel` to produce portable wheels
- Creates a GitHub Release with wheels as assets on tag push

### Modified: `run_anuga/.github/workflows/release.yml`
- Downloads pre-built wheels from `Hydrata/anuga_core` releases via `gh release download`
- No more `pip install "anuga @ git+..."` (no compilation on run_anuga CI)
- Removed `build-essential gfortran libhdf5-dev libnetcdf-dev` from Linux apt-get (kept `libopenmpi-dev openmpi-bin` for mpi4py)
- Added `workflow_dispatch` trigger with `anuga_core_tag` input (defaults to `latest`)
- Added `if: github.ref_type == 'tag'` guard on release job for workflow_dispatch runs

### Why this works
anuga_core's CI already solves the Windows compiler problem using conda's `gcc_win-64` package. By building wheels there and downloading them in run_anuga's CI, we avoid the compilation entirely.

### Remaining concern
The `collect_all('anuga')` → "not a package" warning on Windows is a separate PyInstaller issue. The importlib fallback in `run_anuga.spec` should handle it, but needs validation once the full pipeline runs.

## Files Modified (from initial state)

| File | Change |
|------|--------|
| `.github/workflows/release.yml` | Single exe, smoke tests, renamed example |
| `README.md` | `australian_floodplain` → `small_test`, scenario.json paths |
| `examples/small_test/` | Renamed from `australian_floodplain`, updated scenario.json name |
| `run_anuga.spec` | Onefile mode, importlib fallback for anuga, removed examples from bundle |
| `run_anuga/cli.py` | Added `resolve_package_dir()` — accepts scenario.json or directory |
| `run_anuga/run_utils.py` | 9 ruff lint fixes |
| `pyinstaller_hooks/rthook_projdata.py` | Runtime hook for PROJ_DATA/GDAL_DATA |
| `test-docker/phase1.sh` | Renamed example paths |
| `test-docker/phase2.sh` | Renamed example paths, `@remove-gdal` → `@main` |
| `test-docker/phase3.sh` | Renamed example paths, `@remove-gdal` → `@main` |

## Key Architecture Decisions

- **Single-file exe** (`--onefile`) instead of directory bundle — simpler distribution
- **Examples shipped outside exe** — in the release zip/tarball alongside the exe
- **importlib fallback** in spec — when `collect_all('anuga')` fails (Windows), manually walk the anuga install dir
- **Runtime hook** for PROJ — prefers rasterio's PROJ data over pyproj's (version mismatch otherwise)
