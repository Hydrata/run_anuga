# Release Status

## Current State (2026-02-24)

**Latest release: v0.1.4** — all three platforms passing, clean INFO-level logging.

Release assets:
- `run-anuga-windows.zip`
- `run-anuga-ubuntu2204.tar.gz`
- `run-anuga-ubuntu2404.tar.gz`

### v0.1.4 (2026-02-24)
- Simplified release asset names (dropped `linux-amd64` prefix for ubuntu packages)

### v0.1.3 (2026-02-23)
- Default file log level changed from DEBUG to INFO (log went from 3666 lines / 340KB to 116 lines / 12KB)
- Removed `domain.write_time()` from evolve loop (duplicated progress line)
- Downgraded 21 CRITICAL calls to INFO/DEBUG/WARNING
- Added output file path logging (SWW path+size, tif count, log file path)

### v0.1.2 (2026-02-23)
- Unified simulation logging to capture ANUGA output in run_anuga log file

### v0.1.1 (2026-02-23)
- Build on ubuntu-22.04 + 24.04, shortened exe name, added PowerShell docs

## Next Steps

1. Test the Windows exe on desktop
2. Contribute `build-wheels.yml` upstream to anuga-community

## What's Been Done

### Completed
1. GDAL removal merged to `main` on both `anuga_core` and `run_anuga`
2. anuga_core CI fixed (added pytest, --no-build-isolation, all undeclared deps)
3. run_anuga lint fixed (9 ruff errors in run_utils.py)
4. Docker test scripts updated (`@remove-gdal` → `@main`)
5. CLI now accepts `scenario.json` path directly (not just directory) via `resolve_package_dir()` in cli.py
6. Example renamed: `examples/australian_floodplain/` → `examples/small_test/`
7. PyInstaller spec converted from `--onedir` (exe + `_internal/`) to `--onefile` (single exe)
8. Added importlib-based fallback for anuga collection when `collect_all()` fails on Windows
9. Added runtime hook (`pyinstaller_hooks/rthook_projdata.py`) for PROJ_DATA/GDAL_DATA
10. Fixed rasterio data bundling (newer rasterio has `proj_data`/`gdal_data` dirs, not functions)
11. Release workflow has full simulation smoke tests on both platforms (validate → info → run → verify outputs)
12. Examples shipped alongside exe in release zip/tarball (not embedded in exe)
13. All references to `australian_floodplain` updated across README, docker scripts, release workflow
14. **Pre-built wheel pipeline**: anuga_core builds wheels with conda → run_anuga downloads them
15. **Lazy pymetis import**: METIS can't compile on Windows; import made lazy in distribute_mesh.py
16. **Baseline x86-64**: Wheel build uses `-march=x86-64 -mtune=generic` to avoid SIGILL

### v0.1.0 Tag
Tag exists on remote pointing to commit `83bc0ed`. Release workflow run `22276470913` failed (Windows).
Will need to delete and re-create after merging `prebuilt-wheels`.

## Solution: Pre-built Wheels

### New workflow: `anuga_core/.github/workflows/build-wheels.yml`
- Builds Linux + Windows wheels for Python 3.12
- Uses conda + `gcc_win-64`/`gxx_win-64` on Windows, `compilers` on Linux
- **Critical**: Sets `CFLAGS="-march=x86-64 -mtune=generic"` to avoid SIGILL
- Uses `repairwheel` to produce portable wheels
- Creates a GitHub Release with wheels as assets on tag push

### Modified: `anuga_core/anuga/parallel/distribute_mesh.py`
- pymetis import made lazy (try/except at module level)
- METIS can't compile on Windows with any compiler (needs POSIX headers)
- Guard at usage site raises ImportError with helpful message

### Modified: `run_anuga/.github/workflows/release.yml`
- Both platforms download pre-built wheels via `gh release download`
- No compilation of anuga in run_anuga CI
- `workflow_dispatch` trigger with `anuga_core_tag` input (defaults to `latest`)
- `if: github.ref_type == 'tag'` guard on release job

### Key debugging lessons
See `notes/wheel-build-debug-log.md` for the complete 11-attempt debugging log.
See `notes/pyinstaller-lessons.md` for updated PyInstaller-specific lessons.

## Files Modified (from initial state)

| File | Change |
|------|--------|
| `.github/workflows/release.yml` | Pre-built wheels for both platforms, smoke tests |
| `README.md` | `australian_floodplain` → `small_test`, scenario.json paths |
| `examples/small_test/` | Renamed from `australian_floodplain`, updated scenario.json name |
| `run_anuga.spec` | Onefile mode, importlib fallback for anuga, removed pymetis |
| `run_anuga/cli.py` | Added `resolve_package_dir()` — accepts scenario.json or directory |
| `run_anuga/run_utils.py` | 9 ruff lint fixes |
| `pyinstaller_hooks/rthook_projdata.py` | Runtime hook for PROJ_DATA/GDAL_DATA |
| `test-docker/phase1.sh` | Renamed example paths |
| `test-docker/phase2.sh` | Renamed example paths, `@remove-gdal` → `@main` |
| `test-docker/phase3.sh` | Renamed example paths, `@remove-gdal` → `@main` |

## Key Architecture Decisions

- **Single-file exe** (`--onefile`) instead of directory bundle — simpler distribution
- **Examples shipped outside exe** — in the release zip/tarball alongside the exe
- **importlib fallback** in spec — when `collect_all('anuga')` fails (Windows), manually walk the anuga install dir
- **Runtime hook** for PROJ — prefers rasterio's PROJ data over pyproj's (version mismatch otherwise)
- **Baseline x86-64** compilation — conda compilers default to aggressive optimization that causes SIGILL
- **Lazy pymetis** — METIS is POSIX-only, can't compile on Windows; only needed for parallel runs
